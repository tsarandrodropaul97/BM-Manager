{% extends 'base.html.twig' %}

{% block title %}Gestion des Biens Immobilier
{% endblock %}

{% block body %}
	<!-- En-tête page -->
	<div class="card mb-3">
		<div class="card-header">
			<div class="row flex-between-end">
				<div class="col-auto align-self-center">
					<h5 class="mb-0">Gestion des Biens Immobilier</h5>
					<p class="mb-0 fs-11 text-muted">Aperçu et gestion de votre parc immobilier</p>
				</div>
				<div class="col-auto ms-auto">
					<div class="d-flex gap-2">
						{% if is_granted('ROLE_ADMIN') %}
							<a href="{{ path('app_biens_export', app.request.query.all) }}" class="btn btn-outline-secondary btn-sm">
								<span class="fas fa-file-export me-1"></span>Exporter
							</a>
							<a href="{{ path('app_biens_new') }}" class="btn btn-primary btn-sm">
								<span class="fas fa-plus me-1"></span>Ajouter un bien
							</a>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Filtres et Stats rapide -->
	<div class="row g-3 mb-3">
		<div class="col-lg-12">
			<div class="card">
				<div class="card-body">
					<form method="get" action="{{ path('app_biens_index') }}" class="row g-2 align-items-center">
						<div class="col-md-4">
							<div class="input-group">
								<span class="input-group-text bg-200 border-end-0">
									<span class="fas fa-search text-600"></span>
								</span>
								<input type="text" name="search" value="{{ filters.search }}" class="form-control border-start-0 ps-0" placeholder="Rechercher par désignation ou ville...">
							</div>
						</div>
						<div class="col-md-2">
							<select name="statut" class="form-select">
								<option value="">Tous les statuts</option>
								<option value="vacant" {{ filters.statut == 'vacant' ? 'selected' : '' }}>Vacants</option>
								<option value="occupe" {{ filters.statut == 'occupe' ? 'selected' : '' }}>Occupés</option>
								<option value="travaux" {{ filters.statut == 'travaux' ? 'selected' : '' }}>En travaux</option>
							</select>
						</div>
						<div class="col-md-2">
							<input type="text" name="ville" value="{{ filters.ville }}" class="form-control" placeholder="Ville">
						</div>
						<input type="hidden" name="viewMode" value="{{ viewMode }}">
						<div class="col-auto ms-auto">
							<button type="submit" class="btn btn-primary">Filtrer</button>
							<a href="{{ path('app_biens_index') }}" class="btn btn-link py-0 text-muted">Réinitialiser</a>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="row g-3 mb-3">
		<div class="col-sm-6 col-lg-3">
			<div class="card border-0 h-100 bg-subtle-primary">
				<div class="card-body text-center py-4">
					<div class="fs-4 fw-bold text-primary mb-1">{{ stats.total }}</div>
					<h6 class="text-primary mb-0 opacity-75 fw-semi-bold">Total Biens</h6>
				</div>
			</div>
		</div>
		<div class="col-sm-6 col-lg-3">
			<div class="card border-0 h-100 bg-subtle-success">
				<div class="card-body text-center py-4">
					<div class="fs-4 fw-bold text-success mb-1">{{ stats.occupes }}</div>
					<h6 class="text-success mb-0 opacity-75 fw-semi-bold">Occupés</h6>
				</div>
			</div>
		</div>
		<div class="col-sm-6 col-lg-3">
			<div class="card border-0 h-100 bg-subtle-warning">
				<div class="card-body text-center py-4">
					<div class="fs-4 fw-bold text-warning mb-1">{{ stats.enTravaux }}</div>
					<h6 class="text-warning mb-0 opacity-75 fw-semi-bold">En travaux</h6>
				</div>
			</div>
		</div>
		<div class="col-sm-6 col-lg-3">
			<div class="card border-0 h-100 bg-subtle-danger">
				<div class="card-body text-center py-4">
					<div class="fs-4 fw-bold text-danger mb-1">{{ stats.vacants }}</div>
					<h6 class="text-danger mb-0 opacity-75 fw-semi-bold">Vacants</h6>
				</div>
			</div>
		</div>
	</div>

	<!-- Liste des biens -->
	<div class="card mb-3">
		<div class="card-header border-bottom">
			<div class="row flex-between-center">
				<div class="col-auto">
					<h6 class="mb-0">Résultats de la recherche ({{ pagination.getTotalItemCount }})</h6>
				</div>
				<div class="col-auto">
					<div class="btn-group btn-group-sm" role="group">
						<a href="{{ path('app_biens_index', app.request.query.all|merge({'viewMode': 'grid'})) }}" class="btn {% if viewMode == 'grid' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
							<span class="fas fa-th"></span>
						</a>
						<a href="{{ path('app_biens_index', app.request.query.all|merge({'viewMode': 'list'})) }}" class="btn {% if viewMode == 'list' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
							<span class="fas fa-list"></span>
						</a>
					</div>
				</div>
			</div>
		</div>
		<div class="card-body p-0">
			{% if viewMode == 'grid' %}
				<!-- Mode grille -->
				<div class="row g-3 p-3">
					{% for bien in pagination %}
						<div class="col-md-6 col-lg-4">
							<div class="card h-100 shadow-none border">
								<div class="position-relative">
									<div style="height: 180px; background: #eaedf2; display: flex; align-items: center; justify-content: center; overflow: hidden;">
										{% if bien.image %}
											<img src="{{ asset('uploads/biens/' ~ bien.image) }}" alt="{{ bien.designation }}" style="width: 100%; height: 100%; object-fit: cover;">
										{% else %}
											<span class="fas fa-image fa-2x text-300"></span>
										{% endif %}
									</div>
									<div class="position-absolute top-0 start-0 m-2">
										{% if bien.statut == 'occupe' %}
											<span class="badge rounded-pill bg-success">Occupé</span>
										{% elseif bien.statut == 'vacant' %}
											<span class="badge rounded-pill bg-danger">Vacant</span>
										{% else %}
											<span class="badge rounded-pill bg-warning">{{ bien.statut|capitalize }}</span>
										{% endif %}
									</div>
								</div>
								<div class="card-body pb-2">
									<h6 class="mb-1 text-truncate">{{ bien.designation }}</h6>
									<p class="fs-11 text-muted mb-2">
										<span class="fas fa-map-marker-alt me-1"></span>
										{{ bien.ville }}</p>
									<div class="d-flex justify-content-between mb-2">
										<span class="fs-11 text-muted">
											<span class="fas fa-ruler-combined me-1"></span>
											{{ bien.surfaceHabitable }}m²</span>
										<span class="fs-11 text-muted">
											<span class="fas fa-door-open me-1"></span>
											{{ bien.nbrPiece }}
											pcs</span>
									</div>
								</div>
								<div class="card-footer py-2 border-top">
									<div class="d-flex justify-content-between align-items-center">
										<div class="d-flex flex-column">
											<small class="text-600 fw-semi-bold">{{ bien.reference }}</small>
											{% if is_granted('ROLE_ADMIN') or (app.user.locataire and app.user.locataire.bien and app.user.locataire.bien.id == bien.id) %}
												<div class="text-primary fw-bold fs-10">{{ bien.prix ? bien.prix|number_format(0, ',', ' ') ~ ' Ar' : 'N/A' }}</div>
											{% endif %}
										</div>
										<a href="{{ path('app_biens_show', {'id': bien.id}) }}" class="btn btn-link btn-sm p-0">
											{{ is_granted('ROLE_ADMIN') ? 'Gérer' : 'Détails' }}
											<span class="fas fa-chevron-right ms-1 fs-11"></span>
										</a>
									</div>
								</div>
							</div>
						</div>
					{% else %}
						<div class="col-12 text-center py-5">
							<span class="fas fa-search-minus fa-4x text-200 mb-3"></span>
							<p class="text-600 fs-4 fw-semi-bold">Aucun bien trouvé.</p>
							<p class="text-500 fs-11">Essayez de modifier vos critères de recherche.</p>
						</div>
					{% endfor %}
				</div>
			{% else %}
				<!-- Mode liste (Table) -->
				<div class="table-responsive scrollbar">
					<table class="table table-sm table-striped fs-11 mb-0">
						<thead class="bg-200 text-900">
							<tr>
								<th class="align-middle ps-3">Bien</th>
								<th class="align-middle">Référence</th>
								<th class="align-middle">Ville</th>
								<th class="align-middle">Statut</th>
								<th class="align-middle text-center">Surface</th>
								<th class="align-middle text-center">Pièces</th>
								<th class="align-middle text-center">Loyer</th>
								<th class="align-middle text-end pe-3">Actions</th>
							</tr>
						</thead>
						<tbody>
							{% for bien in pagination %}
								<tr>
									<td class="align-middle ps-3">
										<div class="d-flex align-items-center">
											<div class="avatar avatar-l me-2">
												{% if bien.image %}
													<img src="{{ asset('uploads/biens/' ~ bien.image) }}" alt="" class="rounded" style="width: 40px; height: 40px; object-fit: cover;">
												{% else %}
													<div class="bg-subtle-primary text-primary d-flex align-items-center justify-content-center rounded" style="width: 40px; height: 40px;">
														<span class="fas fa-image fs-11"></span>
													</div>
												{% endif %}
											</div>
											<div>
												<h6 class="mb-0 text-nowrap">{{ bien.designation }}</h6>
												<p class="mb-0 fs-11 text-muted text-nowrap">{{ bien.categorie ? bien.categorie.nom : 'Non classé' }}</p>
											</div>
										</div>
									</td>
									<td class="align-middle fw-semi-bold">{{ bien.reference }}</td>
									<td class="align-middle">{{ bien.ville }}</td>
									<td class="align-middle">
										{% if bien.statut == 'occupe' %}
											<span class="badge badge-subtle-success">Occupé</span>
										{% elseif bien.statut == 'vacant' %}
											<span class="badge badge-subtle-danger">Vacant</span>
										{% else %}
											<span class="badge badge-subtle-warning">{{ bien.statut|capitalize }}</span>
										{% endif %}
									</td>
									<td class="align-middle text-center">{{ bien.surfaceHabitable }}
										m²</td>
									<td class="align-middle text-center">{{ bien.nbrPiece }}</td>
									<td class="align-middle text-center fw-bold text-primary">
										{% if is_granted('ROLE_ADMIN') or (app.user.locataire and app.user.locataire.bien and app.user.locataire.bien.id == bien.id) %}
											{{ bien.prix ? bien.prix|number_format(0, ',', ' ') ~ ' Ar' : 'N/A' }}
										{% else %}
											<span class="text-300">-</span>
										{% endif %}
									</td>
									<td class="align-middle text-end pe-3">
										<div class="btn-group btn-group-sm">
											<a href="{{ path('app_biens_show', {'id': bien.id}) }}" class="btn btn-light" title="{{ is_granted('ROLE_ADMIN') ? 'Gérer' : 'Détails' }}">
												<span class="fas fa-eye"></span>
											</a>
											{% if is_granted('ROLE_ADMIN') %}
												<a href="{{ path('app_biens_edit', {'id': bien.id}) }}" class="btn btn-light" title="Modifier">
													<span class="fas fa-edit"></span>
												</a>
											{% endif %}
										</div>
									</td>
								</tr>
							{% else %}
								<tr>
									<td colspan="7" class="text-center py-5">
										<span class="fas fa-search-minus fa-3x text-200 mb-3"></span>
										<p class="text-600 fs-4 fw-semi-bold">Aucun bien trouvé.</p>
										<p class="text-500 fs-11">Essayez de modifier vos critères de recherche.</p>
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			{% endif %}
		</div>

		<!-- Pagination -->
		<div class="card-footer d-flex align-items-center justify-content-between py-2 border-top">
			<span class="fs-11 text-600">Affiche
				{{ pagination|length }}
				sur
				{{ pagination.getTotalItemCount }}
				résultats</span>
			{{ knp_pagination_render(pagination) }}
		</div>
	</div>
{% endblock %}
