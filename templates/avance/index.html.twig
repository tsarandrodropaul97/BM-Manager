{% extends 'base.html.twig' %}

{% block title %}Historique des Avances
{% endblock %}

{% block body %}
	<!-- En-tête page -->
	<div class="card mb-3">
		<div class="card-header border-bottom">
			<div class="row flex-between-end">
				<div class="col-auto align-self-center">
					<h5 class="mb-0">Historique des Avances</h5>
					<p class="mb-0 fs-11 text-muted">Consultation des versements effectués et solde de déduction automatique</p>
				</div>
				<div class="col-auto ms-auto">
					<div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#modalAvance">
                            <span class="fas fa-plus me-1"></span>{{ is_granted('ROLE_ADMIN') ? 'Saisir une Avance' : 'Déclarer un Versement' }}
                        </button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Filtres -->
	<div class="card mb-3">
		<div class="card-body">
			<form method="get" action="{{ path('app_avance_index') }}" class="row g-2 align-items-center">
				{% if is_granted('ROLE_ADMIN') %}
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text bg-200 border-end-0">
                                <span class="fas fa-user text-600"></span>
                            </span>
                            <input type="text" name="search" value="{{ filters.search|default('') }}" class="form-control border-start-0 ps-0" placeholder="Nom du locataire...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select name="bienId" class="form-select" aria-label="Choisir un bien">
                            <option value="">Tous les biens</option>
                            {% for bien in biens %}
                                <option value="{{ bien.id }}" {{ filters.bienId == bien.id ? 'selected' : '' }}>
                                    {{ bien.designation }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}
                
                <div class="{{ is_granted('ROLE_ADMIN') ? 'col-md-2' : 'col-md-4' }}">
                    <div class="input-group">
                        <span class="input-group-text bg-200 border-end-0 fs-11">
                            <span class="fas fa-calendar-alt text-600"></span>
                        </span>
					    <input type="date" name="date" value="{{ filters.date|default('') }}" class="form-control border-start-0 ps-0" title="Filtrer par date de versement">
                    </div>
				</div>
                
				<div class="col-auto ms-auto">
					<button type="submit" class="btn btn-primary">
                        <span class="fas fa-filter me-1"></span>Filtrer
                    </button>
					<a href="{{ path('app_avance_index') }}" class="btn btn-link py-0 text-muted">Réinitialiser</a>
				</div>
			</form>
		</div>
	</div>

    {% if stats.locataireStats %}
        <!-- Configuration Déduction -->
        <div class="card mb-3 border-subtle-info bg-subtle-info shadow-none">
            <div class="card-body py-2 px-3">
                {% if is_granted('ROLE_ADMIN') %}
                    <form action="{{ path('app_avance_index', app.request.query.all) }}" method="POST" class="row g-3 align-items-center">
                        <input type="hidden" name="locataireId" value="{{ stats.locataireStats.id }}">
                        <div class="col-auto">
                            <span class="fas fa-cog text-info me-2"></span>
                            <span class="fs-11 fw-bold text-700 text-uppercase">Début de déduction automatique :</span>
                        </div>
                        <div class="col-auto">
                            <input type="date" name="dateDebutDeduction" value="{{ stats.locataireStats.dateDebutDeduction ? stats.locataireStats.dateDebutDeduction|date('Y-m-d') : '' }}" class="form-control form-control-sm border-info" style="width: 160px;">
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-info btn-sm px-3">
                                <span class="fas fa-save me-1"></span>Définir
                            </button>
                        </div>
                        <div class="col">
                            <p class="mb-0 fs-11 text-muted italic">
                                <span class="fas fa-question-circle me-1"></span>
                                Par défaut, le calcul commence à la date de la première avance.
                            </p>
                        </div>
                    </form>
                {% else %}
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <span class="fas fa-info-circle text-info me-2"></span>
                            <span class="fs-11 fw-bold text-700 text-uppercase">Point de départ du calcul :</span>
                        </div>
                        <div class="col-auto">
                            <span class="badge badge-subtle-info fs-10">
                                {{ stats.locataireStats.dateDebutDeduction ? stats.locataireStats.dateDebutDeduction|date('d/m/Y') : (avances|last.dateAccord|default(now)|date('d/m/Y')) }}
                            </span>
                        </div>
                        <div class="col">
                            <p class="mb-0 fs-11 text-muted italic">
                                Vos statistiques sont calculées automatiquement à partir de cette date initiale.
                            </p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <!-- Statistiques Résumées -->
    <div class="row g-3 mb-3">
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-none border border-secondary bg-transparent">
                <div class="card-body p-3">
                    <div class="d-flex flex-between-center">
                        <div>
                            <h6 class="text-uppercase fs-11 fw-bold text-muted mb-1">Crédit Actuel</h6>
                            <h4 class="text-white mb-0 fw-bolder">{{ stats.totalAvance|number_format(0, ',', ' ') }} Ar</h4>
                        </div>
                        <div class="p-2 bg-subtle-primary rounded-circle">
                            <span class="fas fa-wallet text-primary fs-11"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-none border border-secondary bg-transparent">
                <div class="card-body p-3">
                    <div class="d-flex flex-between-center">
                        <div>
                            <h6 class="text-uppercase fs-11 fw-bold text-muted mb-1">Mois Restants</h6>
                            <h4 class="text-white mb-0 fw-bolder">{{ stats.nbMoisCouverts }} Mois</h4>
                        </div>
                        <div class="p-2 bg-subtle-primary rounded-circle">
                            <span class="fas fa-calendar-check text-primary fs-11"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-none border border-secondary bg-transparent">
                <div class="card-body p-3">
                    <div class="d-flex flex-between-center">
                        <div>
                            <h6 class="text-uppercase fs-11 fw-bold text-muted mb-1">Date de Reprise</h6>
                            <h4 class="text-white mb-0 fw-bolder">{{ stats.dateReprise ? stats.dateReprise|date('M Y') : 'N/A' }}</h4>
                        </div>
                        <div class="p-2 bg-subtle-primary rounded-circle">
                            <span class="fas fa-hourglass-start text-primary fs-11"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-none border border-secondary bg-transparent">
                <div class="card-body p-3">
                    <div class="d-flex flex-between-center">
                        <div>
                            <h6 class="text-uppercase fs-11 fw-bold text-muted mb-1">Reliquat de mois</h6>
                            <h4 class="text-white mb-0 fw-bolder">{{ stats.reliquatGlobal|number_format(0, ',', ' ') }} Ar</h4>
                        </div>
                        <div class="p-2 bg-subtle-primary rounded-circle">
                            <span class="fas fa-coins text-primary fs-11"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<!-- Liste des avances -->
	<div class="card mb-3">
		<div class="card-header border-bottom">
			<h6 class="mb-0">Liste des Avances ({{ avances|length }})</h6>
		</div>
		<div class="card-body p-0">
			<div class="table-responsive scrollbar">
				<table class="table table-sm table-striped fs-11 mb-0">
					<thead class="bg-200 text-900">
						<tr>
							<th class="align-middle ps-3">Date Versement</th>
							{% if is_granted('ROLE_ADMIN') %}
								<th class="align-middle">Locataire</th>
							{% endif %}
							<th class="align-middle">Bien & Résidence</th>
							<th class="align-middle text-end">Montant Versé</th>
							<th class="align-middle text-center">Justificatifs</th>
							<th class="align-middle text-center">Statut</th>
							<th class="align-middle text-end pe-3">Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for avance in avances %}
							<tr>
								<td class="align-middle ps-3">
									<span class="fw-semi-bold">{{ avance.dateAccord|date('d/m/Y') }}</span>
								</td>
								{% if is_granted('ROLE_ADMIN') %}
									<td class="align-middle">
										<div class="d-flex align-items-center">
											<div class="avatar avatar-l me-2">
                                                <div class="bg-subtle-primary text-primary d-flex align-items-center justify-content-center rounded-circle" style="width: 30px; height: 30px;">
                                                    <span class="fs-11">{{ avance.locataire.nomComplet|slice(0, 1) }}</span>
                                                </div>
											</div>
											<div>
												<h6 class="mb-0 text-nowrap text-white">{{ avance.locataire.nomComplet }}</h6>
											</div>
										</div>
									</td>
								{% endif %}
								<td class="align-middle text-muted">
									<span class="fas fa-building me-1 opacity-50"></span>
									{{ avance.locataire.bien ? avance.locataire.bien.designation : 'Non assigné' }}
								</td>
								<td class="align-middle text-end text-primary fw-bold">
									{{ avance.montantTotal|number_format(0, ',', ' ') }} Ar
								</td>
								<td class="align-middle text-center">
                                    {% if avance.documents|length > 0 %}
                                        {% for doc in avance.documents %}
                                            <button class="btn p-0 border-0 btn-preview-doc" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#modalPreviewDoc" 
                                                    data-filename="{{ doc.filename }}"
                                                    data-original-name="{{ doc.originalName }}"
                                                    title="{{ doc.originalName }}">
                                                <span class="badge badge-subtle-info hover-primary fs-10 cursor-pointer">
                                                    <span class="fas fa-file-alt me-1"></span>Voir
                                                </span>
                                            </button>
                                        {% endfor %}
                                    {% else %}
                                        <span class="badge badge-subtle-secondary fs-10">
                                            <span class="fas fa-times-circle me-1"></span>0
                                        </span>
                                    {% endif %}
								</td>
								<td class="align-middle text-center">
									{% if avance.status == 'validée' %}
										<span class="badge badge-subtle-success fs-10">
											<span class="fas fa-check-circle me-1"></span>Validée
										</span>
									{% else %}
										<span class="badge badge-subtle-warning fs-10">
											<span class="fas fa-clock me-1"></span>En attente
										</span>
									{% endif %}
								</td>
								<td class="align-middle text-end pe-3">
									<div class="btn-group btn-group-sm">
										{% set canApprove = false %}
										{% if is_granted('ROLE_ADMIN') and not avance.isApprovedByAdmin %}
											{% set canApprove = true %}
										{% elseif not is_granted('ROLE_ADMIN') and app.user.locataire and avance.locataire.id == app.user.locataire.id and not avance.isApprovedByLocataire %}
											{% set canApprove = true %}
										{% endif %}

										{% if canApprove %}
											<form action="{{ path('app_avance_approve', {id: avance.id}) }}" method="POST" class="d-inline">
												<button type="submit" class="btn btn-success me-1" title="Valider">
													<span class="fas fa-check"></span>
												</button>
											</form>
										{% endif %}

										<a href="{{ path('app_avance_show', {'id': avance.id}) }}" class="btn btn-light" title="Détails">
											<span class="fas fa-eye"></span>
										</a>
									</div>
								</td>
							</tr>
						{% else %}
							<tr>
								<td colspan="{{ is_granted('ROLE_ADMIN') ? 7 : 6 }}" class="text-center py-5">
									<span class="fas fa-search-minus fa-3x text-200 mb-3"></span>
									<p class="text-600 fs-4 fw-semi-bold">Aucune avance trouvée.</p>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Modal de création d'avance -->
	<div class="modal fade" id="modalAvance" tabindex="-1" role="dialog" aria-labelledby="modalAvanceLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content border-0 bg-dark">
				<div class="modal-header bg-black bg-opacity-20 border-bottom border-secondary py-3 px-4">
					<h5 class="modal-title text-white" id="modalAvanceLabel">
						<span class="fas fa-hand-holding-usd me-2 text-primary"></span>
						{{ is_granted('ROLE_ADMIN') ? 'Octroyer une Avance' : 'Déclarer une Avance' }}
					</h5>
					<button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				{{ form_start(form, {'attr': {'id': 'formAvance'}}) }}
				<div class="modal-body py-4 px-4 text-white">
					<div class="alert alert-subtle-info fs-11 border-info-subtle mb-4 shadow-none">
						<span class="fas fa-info-circle me-2"></span>
						Saisissez les différents montants constituant cette avance. Ils seront additionnés automatiquement.
					</div>

					{% if form.locataire is defined %}
						<div class="mb-3">
							<label class="form-label text-400 fw-bold fs-11 text-uppercase">{{ form_label(form.locataire) }}</label>
							{{ form_widget(form.locataire, {'attr': {'class': 'form-select bg-100 text-900 fs-11 border border-300'}}) }}
						</div>
					{% endif %}

					<div class="row g-3 align-items-end mb-3">
						<div class="col">
							<label class="form-label text-400 fw-bold fs-11 text-uppercase">Ajouter un montant</label>
							<div class="input-group">
								<input type="number" id="inputPartialAmount" class="form-control bg-100 text-900 fs-11 border border-300" placeholder="Ex: 500000">
								<span class="input-group-text bg-200 text-900 fs-11 border border-300">Ar</span>
							</div>
						</div>
						<div class="col-auto">
							<button type="button" id="btnAddAmount" class="btn btn-primary btn-sm px-3">
								<span class="fas fa-plus"></span>
							</button>
						</div>
					</div>

					<!-- Liste des montants ajoutés -->
					<div id="amountListContainer" class="mb-3 p-3 bg-black bg-opacity-20 rounded border border-secondary d-none">
						<div class="d-flex flex-wrap gap-2 mb-2" id="amountBadgeContainer">
							<!-- Badges des montants injectés ici -->
						</div>
						<div class="border-top border-secondary pt-2 mt-2 d-flex justify-content-between align-items-center">
							<span class="fs-11 text-400 text-uppercase fw-bold">Somme Totale :</span>
							<h5 class="mb-0 text-white" id="displayTotalTotal">0 Ar</h5>
						</div>
					</div>

					{{ form_widget(form.montantTotal) }}
					{{ form_widget(form.montantDetails) }}

					<div class="mb-3">
						<label class="form-label text-400 fw-bold fs-11 text-uppercase">Date versement</label>
						{{ form_widget(form.dateAccord, {'attr': {'class': 'form-control bg-100 text-900 fs-11 border border-300'}}) }}
					</div>

					<div class="mb-3">
						<label class="form-label text-400 fw-bold fs-11 text-uppercase">Preuve de versement (PDF/Image)</label>
						{{ form_widget(form.document, {'attr': {'class': 'form-control bg-100 text-900 fs-11 border border-300'}}) }}
					</div>

					<div class="mb-0">
						<label class="form-label text-400 fw-bold fs-11 text-uppercase">Observations</label>
						{{ form_widget(form.motif, {'attr': {'class': 'form-control bg-100 text-900 fs-11 border border-300', 'rows': '2'}}) }}
					</div>
				</div>
				<div class="modal-footer bg-black bg-opacity-20 border-top border-secondary py-3 px-4">
					<button class="btn btn-secondary btn-sm" type="button" data-bs-dismiss="modal">Annuler</button>
					<button class="btn btn-primary btn-sm px-4" type="submit" id="btnSubmitAvance" disabled>
						<span class="fas fa-check-circle me-1" id="btnIcon"></span>
						<span class="spinner-border spinner-border-sm d-none me-1" role="status" id="btnSpinner"></span>
						Enregistrer
					</button>
				</div>
				{{ form_end(form) }}
			</div>
		</div>
	</div>

    <!-- Modal de visualisation de document -->
    <div class="modal fade" id="modalPreviewDoc" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content border-0 bg-dark">
                <div class="modal-header bg-black bg-opacity-20 border-bottom border-secondary py-3 px-4">
                    <h5 class="modal-title text-white" id="previewDocTitle">Aperçu du justificatif</h5>
                    <button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 d-flex justify-content-center align-items-center" style="min-height: 400px; background: #1a1a1a;">
                    <div id="previewContent" class="w-100 h-100 d-flex justify-content-center">
                        <!-- Le contenu (img ou iframe) sera injecté ici par JS -->
                    </div>
                </div>
                <div class="modal-footer bg-black bg-opacity-20 border-top border-secondary py-2 px-4">
                    <a href="#" id="btnDownloadDoc" class="btn btn-primary btn-sm" download>
                        <span class="fas fa-download me-1"></span>Télécharger
                    </a>
                    <button class="btn btn-secondary btn-sm" type="button" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
            // Logique de saisie de montants multiples
            const inputPartial = document.getElementById('inputPartialAmount');
            const btnAdd = document.getElementById('btnAddAmount');
            const amountListContainer = document.getElementById('amountListContainer');
            const amountBadgeContainer = document.getElementById('amountBadgeContainer');
            const displayTotal = document.getElementById('displayTotalTotal');
            
            const hiddenTotalInput = document.querySelector('input[name="avance_sur_loyer[montantTotal]"]');
            const hiddenDetailsInput = document.querySelector('input[name="avance_sur_loyer[montantDetails]"]');
            const btnSubmitAvance = document.getElementById('btnSubmitAvance');

            let partialAmounts = [];

            function updateAmountUI() {
                amountBadgeContainer.innerHTML = '';
                let total = 0;
                
                partialAmounts.forEach((amt, index) => {
                    total += amt;
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-subtle-primary p-2 fs-10 d-flex align-items-center';
                    badge.innerHTML = `
                        ${amt.toLocaleString()} Ar
                        <span class="fas fa-times ms-2 cursor-pointer text-danger" onclick="removePartial(${index})"></span>
                    `;
                    amountBadgeContainer.appendChild(badge);
                });

                if (partialAmounts.length > 0) {
                    amountListContainer.classList.remove('d-none');
                    btnSubmitAvance.disabled = false;
                } else {
                    amountListContainer.classList.add('d-none');
                    btnSubmitAvance.disabled = true;
                }

                displayTotal.textContent = total.toLocaleString() + ' Ar';
                hiddenTotalInput.value = total;
                hiddenDetailsInput.value = JSON.stringify(partialAmounts);
            }

            window.removePartial = function(index) {
                partialAmounts.splice(index, 1);
                updateAmountUI();
            };

            btnAdd.addEventListener('click', function() {
                const val = parseFloat(inputPartial.value);
                if (!isNaN(val) && val > 0) {
                    partialAmounts.push(val);
                    inputPartial.value = '';
                    updateAmountUI();
                    inputPartial.focus();
                }
            });

            inputPartial.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    btnAdd.click();
                }
            });


            // Spinner logic
            const form = document.getElementById('formAvance');
            const btnSubmit = document.getElementById('btnSubmitAvance');
            const btnSpinner = document.getElementById('btnSpinner');
            const btnIcon = document.getElementById('btnIcon');

            if (form) {
                form.addEventListener('submit', function () {
                    btnSubmit.disabled = true;
                    btnSpinner.classList.remove('d-none');
                    btnIcon.classList.add('d-none');
                });
            }

            // Preview logic
            const previewModal = document.getElementById('modalPreviewDoc');
            const previewContent = document.getElementById('previewContent');
            const previewTitle = document.getElementById('previewDocTitle');
            const btnDownload = document.getElementById('btnDownloadDoc');

            const previewButtons = document.querySelectorAll('.btn-preview-doc');
            
            previewButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filename = this.getAttribute('data-filename');
                    const originalName = this.getAttribute('data-original-name');
                    const fileUrl = '/uploads/avances/' + filename;
                    const extension = filename.split('.').pop().toLowerCase();

                    previewTitle.textContent = originalName;
                    btnDownload.href = fileUrl;
                    
                    previewContent.innerHTML = '<div class="text-center p-5"><span class="spinner-border text-primary"></span></div>';

                    setTimeout(() => {
                        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) {
                            previewContent.innerHTML = `<img src="${fileUrl}" class="img-fluid" style="max-height: 80vh; object-fit: contain;">`;
                        } else if (extension === 'pdf') {
                            previewContent.innerHTML = `<iframe src="${fileUrl}" style="width: 100%; height: 75vh; border: none;"></iframe>`;
                        } else {
                            previewContent.innerHTML = `<div class="text-center p-5 text-white">
                                <span class="fas fa-file-download fa-4x mb-3 text-muted"></span>
                                <p>Ce type de fichier ne peut pas être prévisualisé directement.</p>
                                <a href="${fileUrl}" class="btn btn-primary" download>Télécharger le fichier</a>
                            </div>`;
                        }
                    }, 300);
                });
            });

            previewModal.addEventListener('hidden.bs.modal', function () {
                previewContent.innerHTML = '';
            });
        });
	</script>
{% endblock %}
