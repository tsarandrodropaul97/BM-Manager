{% extends 'base.html.twig' %}

{% block title %}Historique des Avances
{% endblock %}

{% block body %}
	<!-- En-tête page -->
	<div class="card mb-3">
		<div class="card-header border-bottom">
			<div class="row flex-between-end">
				<div class="col-auto align-self-center">
					<h5 class="mb-0">Historique des Avances</h5>
					<p class="mb-0 fs-11 text-muted">Consultation des versements effectués et solde de déduction automatique</p>
				</div>
				<div class="col-auto ms-auto">
					<div class="d-flex gap-2">
                        <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#modalAvance">
                            <span class="fas fa-plus me-1"></span>{{ is_granted('ROLE_ADMIN') ? 'Saisir une Avance' : 'Déclarer un Versement' }}
                        </button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Filtres -->
	<div class="card mb-3">
		<div class="card-body">
			<form method="get" action="{{ path('app_avance_index') }}" class="row g-2 align-items-center">
				<div class="col-md-4">
					<div class="input-group">
						<span class="input-group-text bg-200 border-end-0">
							<span class="fas fa-search text-600"></span>
						</span>
						<input type="text" name="search" value="{{ filters.search|default('') }}" class="form-control border-start-0 ps-0" placeholder="Rechercher un locataire ou un bien...">
					</div>
				</div>
                <div class="col-md-3">
					<input type="date" name="date" value="{{ filters.date|default('') }}" class="form-control" title="Filtrer par date">
				</div>
				<div class="col-auto ms-auto">
					<button type="submit" class="btn btn-primary">Filtrer</button>
					<a href="{{ path('app_avance_index') }}" class="btn btn-link py-0 text-muted">Réinitialiser</a>
				</div>
			</form>
		</div>
	</div>

    <!-- Statistiques Résumées -->
    <div class="row g-3 mb-3">
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-none border border-secondary bg-transparent">
                <div class="card-body p-3">
                    <div class="d-flex flex-between-center">
                        <div>
                            <h6 class="text-uppercase fs-11 fw-bold text-muted mb-1">Crédit Total</h6>
                            <h4 class="text-white mb-0 fw-bolder">{{ stats.totalAvance|number_format(0, ',', ' ') }} Ar</h4>
                        </div>
                        <div class="p-2 bg-subtle-primary rounded-circle">
                            <span class="fas fa-wallet text-primary fs-11"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-none border border-secondary bg-transparent">
                <div class="card-body p-3">
                    <div class="d-flex flex-between-center">
                        <div>
                            <h6 class="text-uppercase fs-11 fw-bold text-muted mb-1">Mois Couverts</h6>
                            <h4 class="text-white mb-0 fw-bolder">{{ stats.nbMoisCouverts }} Mois</h4>
                        </div>
                        <div class="p-2 bg-subtle-primary rounded-circle">
                            <span class="fas fa-calendar-check text-primary fs-11"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-none border border-secondary bg-transparent">
                <div class="card-body p-3">
                    <div class="d-flex flex-between-center">
                        <div>
                            <h6 class="text-uppercase fs-11 fw-bold text-muted mb-1">Date de Reprise</h6>
                            <h4 class="text-white mb-0 fw-bolder">{{ stats.dateReprise ? stats.dateReprise|date('M Y') : 'Calcul impossible' }}</h4>
                        </div>
                        <div class="p-2 bg-subtle-primary rounded-circle">
                            <span class="fas fa-hourglass-start text-primary fs-11"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-md-3">
            <div class="card h-100 shadow-none border border-secondary bg-transparent">
                <div class="card-body p-3">
                    <div class="d-flex flex-between-center">
                        <div>
                            <h6 class="text-uppercase fs-11 fw-bold text-muted mb-1">Reliquat de mois</h6>
                            <h4 class="text-white mb-0 fw-bolder">{{ stats.reliquatGlobal|number_format(0, ',', ' ') }} Ar</h4>
                        </div>
                        <div class="p-2 bg-subtle-primary rounded-circle">
                            <span class="fas fa-coins text-primary fs-11"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<!-- Liste des avances -->
	<div class="card mb-3">
		<div class="card-header border-bottom">
			<h6 class="mb-0">Liste des Avances ({{ avances|length }})</h6>
		</div>
		<div class="card-body p-0">
			<div class="table-responsive scrollbar">
				<table class="table table-sm table-striped fs-11 mb-0">
					<thead class="bg-200 text-900">
						<tr>
							<th class="align-middle ps-3">Date Versement</th>
							{% if is_granted('ROLE_ADMIN') %}
								<th class="align-middle">Locataire</th>
							{% endif %}
							<th class="align-middle">Bien & Résidence</th>
							<th class="align-middle text-end">Montant Versé</th>
							<th class="align-middle text-center">Justificatifs</th>
							<th class="align-middle text-end pe-3">Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for avance in avances %}
							<tr>
								<td class="align-middle ps-3">
									<span class="fw-semi-bold">{{ avance.dateAccord|date('d/m/Y') }}</span>
								</td>
								{% if is_granted('ROLE_ADMIN') %}
									<td class="align-middle">
										<div class="d-flex align-items-center">
											<div class="avatar avatar-l me-2">
                                                <div class="bg-subtle-primary text-primary d-flex align-items-center justify-content-center rounded-circle" style="width: 30px; height: 30px;">
                                                    <span class="fs-11">{{ avance.locataire.nomComplet|slice(0, 1) }}</span>
                                                </div>
											</div>
											<div>
												<h6 class="mb-0 text-nowrap text-white">{{ avance.locataire.nomComplet }}</h6>
											</div>
										</div>
									</td>
								{% endif %}
								<td class="align-middle text-muted">
									<span class="fas fa-building me-1 opacity-50"></span>
									{{ avance.locataire.bien ? avance.locataire.bien.designation : 'Non assigné' }}
								</td>
								<td class="align-middle text-end text-primary fw-bold">
									{{ avance.montantTotal|number_format(0, ',', ' ') }} Ar
								</td>
								<td class="align-middle text-center">
									<span class="badge badge-subtle-info">
										<span class="fas fa-file-alt me-1"></span>{{ avance.documents|length }}
									</span>
								</td>
								<td class="align-middle text-end pe-3">
									<div class="btn-group btn-group-sm">
										<a href="{{ path('app_avance_show', {'id': avance.id}) }}" class="btn btn-light" title="Détails">
											<span class="fas fa-eye"></span>
										</a>
									</div>
								</td>
							</tr>
						{% else %}
							<tr>
								<td colspan="{{ is_granted('ROLE_ADMIN') ? 6 : 5 }}" class="text-center py-5">
									<span class="fas fa-search-minus fa-3x text-200 mb-3"></span>
									<p class="text-600 fs-4 fw-semi-bold">Aucune avance trouvée.</p>
								</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Modal de création d'avance -->
	<div class="modal fade" id="modalAvance" tabindex="-1" role="dialog" aria-labelledby="modalAvanceLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered" role="document">
			<div class="modal-content border-0 bg-dark">
				<div class="modal-header bg-black bg-opacity-20 border-bottom border-secondary py-3 px-4">
					<h5 class="modal-title text-white" id="modalAvanceLabel">
						<span class="fas fa-hand-holding-usd me-2 text-primary"></span>
						{{ is_granted('ROLE_ADMIN') ? 'Octroyer une Avance' : 'Déclarer une Avance' }}
					</h5>
					<button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				{{ form_start(form, {'attr': {'id': 'formAvance'}}) }}
				<div class="modal-body py-4 px-4 text-white">
					<div class="alert alert-subtle-info fs-11 border-info-subtle mb-4 shadow-none">
						<span class="fas fa-info-circle me-2"></span>
						Ce montant sera automatiquement déduit des futurs loyers. Une preuve de versement est requise.
					</div>

					{% if form.locataire is defined %}
						<div class="mb-3">
							<label class="form-label text-400 fw-bold fs-11 text-uppercase">{{ form_label(form.locataire) }}</label>
							{{ form_widget(form.locataire, {'attr': {'class': 'form-select bg-dark text-white border-secondary fs-11'}}) }}
						</div>
					{% endif %}

					<div class="row g-3">
						<div class="col-md-6 mb-3">
							<label class="form-label text-400 fw-bold fs-11 text-uppercase">Montant versé</label>
							<div class="input-group">
								{{ form_widget(form.montantTotal, {'attr': {'class': 'form-control bg-dark text-white border-secondary border-end-0 fs-11', 'placeholder': '0'}}) }}
								<span class="input-group-text bg-dark border-secondary text-400 fs-11">Ar</span>
							</div>
						</div>
						<div class="col-md-6 mb-3">
							<label class="form-label text-400 fw-bold fs-11 text-uppercase">Date versement</label>
							{{ form_widget(form.dateAccord, {'attr': {'class': 'form-control bg-dark text-white border-secondary fs-11'}}) }}
						</div>
					</div>

					<div class="mb-3">
						<label class="form-label text-400 fw-bold fs-11 text-uppercase">Preuve de versement (PDF/Image)</label>
						{{ form_widget(form.document, {'attr': {'class': 'form-control bg-dark text-white border-secondary fs-11'}}) }}
					</div>

					<div class="mb-0">
						<label class="form-label text-400 fw-bold fs-11 text-uppercase">Observations</label>
						{{ form_widget(form.motif, {'attr': {'class': 'form-control bg-dark text-white border-secondary fs-11', 'rows': '2'}}) }}
					</div>
				</div>
				<div class="modal-footer bg-black bg-opacity-20 border-top border-secondary py-3 px-4">
					<button class="btn btn-secondary btn-sm" type="button" data-bs-dismiss="modal">Annuler</button>
					<button class="btn btn-primary btn-sm px-4" type="submit" id="btnSubmitAvance">
						<span class="fas fa-check-circle me-1" id="btnIcon"></span>
						<span class="spinner-border spinner-border-sm d-none me-1" role="status" id="btnSpinner"></span>
						Enregistrer
					</button>
				</div>
				{{ form_end(form) }}
			</div>
		</div>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('formAvance');
            const btnSubmit = document.getElementById('btnSubmitAvance');
            const btnSpinner = document.getElementById('btnSpinner');
            const btnIcon = document.getElementById('btnIcon');

            if (form) {
                form.addEventListener('submit', function () {
                    btnSubmit.disabled = true;
                    btnSpinner.classList.remove('d-none');
                    btnIcon.classList.add('d-none');
                });
            }
        });
	</script>
{% endblock %}
