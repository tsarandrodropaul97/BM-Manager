{% extends 'base.html.twig' %}

{% block title %}Détails de l'Opération{% endblock %}

{% block body %}
<!-- En-tête page -->
<div class="card mb-3">
    <div class="card-header border-bottom py-3">
        <div class="row flex-between-center g-3">
            <div class="col-12 col-sm-auto text-center text-sm-start">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb fs-11 ps-0 mb-1">
                        <li class="breadcrumb-item"><a href="{{ path('app_operation_index') }}">Opérations</a></li>
                        <li class="breadcrumb-item active">Détails</li>
                    </ol>
                </nav>
                <h5 class="mb-0">Détails de l'événement</h5>
            </div>
            <div class="col-12 col-sm-auto ms-auto text-center text-sm-end">
                <div class="d-flex gap-2 justify-content-center justify-content-sm-end">
                    <a href="{{ path('app_operation_edit', {id: operation.id}) }}" class="btn btn-primary btn-sm px-4">
                        <span class="fas fa-edit me-1"></span>Modifier
                    </a>
                    <a href="{{ path('app_operation_index') }}" class="btn btn-outline-secondary btn-sm px-3">
                        <span class="fas fa-arrow-left me-2"></span>Retour
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-8">
        <!-- Informations principales -->
        <div class="card mb-3 border-top border-primary border-3">
            <div class="card-body p-4">
                <div class="d-flex align-items-center mb-3">
                    {% set badge_color = 'info' %}
                    {% if operation.type == 'Sinistre' %}{% set badge_color = 'danger' %}
                    {% elseif operation.type == 'Maintenance' %}{% set badge_color = 'warning' %}
                    {% elseif operation.type == 'Déchets' %}{% set badge_color = 'success' %}
                    {% endif %}
                    <span class="badge badge-subtle-{{ badge_color }} rounded-pill px-3 py-1 me-2">{{ operation.type }}</span>
                    <span class="text-600 fs-11"><i class="far fa-calendar-alt me-1"></i> Publié le {{ operation.createdAt|date('d/m/Y à H:i') }}</span>
                </div>
                
                <h3 class="fw-bold text-900 mb-4">{{ operation.titre }}</h3>
                
                <div class="bg-light dark__bg-1100 p-4 rounded-3 mb-4">
                    <h6 class="text-uppercase fs-11 fw-bold text-muted ls-1 mb-3">Description détaillée</h6>
                    <div class="fs-9 text-800" style="white-space: pre-line; line-height: 1.6;">
                        {{ operation.description|default('Aucune description détaillée fournie.') }}
                    </div>
                </div>

                <!-- Documents joints -->
                <h6 class="fw-bold mb-3"><span class="fas fa-paperclip me-2 text-primary"></span>Fichiers & Documents ({{ operation.files|length }})</h6>
                <div class="row g-3">
                    {% for file in operation.files %}
                        <div class="col-sm-6 col-md-4">
                            <div class="card h-100 shadow-none border">
                                <div class="card-body p-3 text-center">
                                    {% set ext = file.filePath|split('.')|last|lower %}
                                    <div class="rounded-3 overflow-hidden mb-2 shadow-sm border" style="height: 140px; background: #eaedf2;" class="dark__bg-1100">
                                        {% if ext in ['jpg', 'jpeg', 'png', 'webp'] %}
                                            <a href="{{ asset('uploads/operations/' ~ file.filePath) }}" target="_blank">
                                                <img src="{{ asset('uploads/operations/' ~ file.filePath) }}" class="w-100 h-100 object-fit-cover">
                                            </a>
                                        {% else %}
                                            <a href="{{ asset('uploads/operations/' ~ file.filePath) }}" target="_blank" class="w-100 h-100 d-flex align-items-center justify-content-center text-decoration-none">
                                                <span class="fas fa-file-pdf fa-4x text-danger opacity-50"></span>
                                            </a>
                                        {% endif %}
                                    </div>
                                    <p class="fs-12 fw-bold text-truncate mb-2" title="{{ file.originalName }}">{{ file.originalName }}</p>
                                    <div class="d-flex justify-content-center gap-2">
                                        <a href="{{ asset('uploads/operations/' ~ file.filePath) }}" target="_blank" class="btn btn-link btn-xs p-0 text-primary">
                                            <span class="fas fa-eye me-1"></span>Voir
                                        </a>
                                        <a href="{{ asset('uploads/operations/' ~ file.filePath) }}" download="{{ file.originalName }}" class="btn btn-link btn-xs p-0 text-secondary">
                                            <span class="fas fa-download me-1"></span>Tél.
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="col-12 py-4 text-center text-muted italic fs-11 bg-light dark__bg-1100 rounded-3">
                            <span class="fas fa-info-circle me-1"></span>Aucun document joint à cette opération.
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Ciblage -->
        <div class="card mb-3">
            <div class="card-header bg-light dark__bg-1100 py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-users me-2 text-warning"></i>Ciblage</h6>
            </div>
            <div class="card-body">
                {% if operation.isGlobal %}
                    <div class="text-center py-2">
                        <div class="avatar avatar-3xl mb-3">
                            <div class="avatar-name rounded-circle bg-subtle-primary text-primary">
                                <span class="fas fa-globe fs-1"></span>
                            </div>
                        </div>
                        <h6 class="fw-bold">Diffusion Globale</h6>
                        <p class="fs-11 text-muted">Tous les locataires voient cette information.</p>
                    </div>
                {% else %}
                    <h6 class="fs-11 text-uppercase fw-bold text-muted ls-1 mb-3">Locataires concernés ({{ operation.targetLocataires|length }})</h6>
                    <div class="scrollbar" style="max-height: 400px;">
                        <ul class="list-group list-group-flush">
                            {% for locataire in operation.targetLocataires %}
                                <li class="list-group-item px-0 py-2 d-flex align-items-center border-0 bg-transparent">
                                    <div class="avatar avatar-l me-2">
                                        <div class="avatar-name rounded-circle bg-subtle-primary text-primary small">
                                            <span>{{ locataire.nom|slice(0, 1) }}{{ locataire.prenom|slice(0, 1) }}</span>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <h6 class="mb-0 fs-11 fw-bold">{{ locataire.nomComplet }}</h6>
                                        <p class="mb-0 fs-12 text-muted">{{ locataire.bien ? locataire.bien.designation : 'N/A' }}</p>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Zone de danger -->
        <div class="card border border-danger bg-subtle-danger">
            <div class="card-body p-3 text-center">
                <h6 class="text-danger fw-bold mb-3 ls-1">Zone de Danger</h6>
                <form method="post" action="{{ path('app_operation_delete', {id: operation.id}) }}" onsubmit="return confirm('Attention : Cette action est irréversible. Confirmer la suppression ?');">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ operation.id) }}">
                    <button class="btn btn-danger btn-sm w-100 rounded-pill shadow-sm">
                        <span class="fas fa-trash-alt me-2"></span>Supprimer l'opération
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
